# Copyright 2025 Emmanuel Madehin
# SPDX-License-Identifier: Apache-2.0

openapi: 3.0.4
info:
  title: Dployr API
  description: |
    Your app, your server, your rules!
    
    ## Authentication
    Dployr instances use JWT-based authentication with tokens **issued by base**.

    ### Token Types (issued by base)
    - **Access Token**: Short-lived (e.g. 10 minutes) for API requests to instances
    - **Refresh Token**: Long-lived (24+ hours) for obtaining new access tokens from base

    ### Authentication Flow
    See https://docs.dployr.dev/auth for more details.
    
    ## Authorization
    Role-based access control with four levels:
    - **Owner**: Full system control, can manage admins
    - **Admin**: Infrastructure management, user management, secrets
    - **Developer**: Deploy apps, view logs and events
    - **Viewer**: Read-only access to services

    See https://docs.dployr.dev/auth for more details.
  version: 1.2.0
  contact:
    name: Emmanuel Madehin
    email: hello@dployr.dev
  license:
    name: Apache License, Version 2.0
    url: https://raw.githubusercontent.com/dployr-io/dployr/refs/heads/master/LICENSE

servers:
  - url: "{address}"
    description: Configurable server
    variables:
      address:
        default: http://localhost:7879
        description: Instance URL

security:
  - BearerAuth: []

paths:
  /deployments:
    get:
      tags:
        - Deployments
      summary: List deployments
      description: Retrieve a list of deployments (Developer+ required)
      operationId: listDeployments
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of deployments to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of deployments to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of deployments
          content:
            application/json:
              schema:
                type: object
                properties:
                  deployments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Deployment'
                  total:
                    type: integer
                    description: Total number of deployments
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Deployments
      summary: Create deployment
      description: Create a new deployment (Developer+ required)
      operationId: createDeployment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '201':
          description: Deployment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /services:
    get:
      tags:
        - Services
      summary: List services
      description: Retrieve a list of services (Viewer+ required)
      operationId: listServices
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of services to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of services to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                type: object
                properties:
                  services:
                    type: array
                    items:
                      $ref: '#/components/schemas/Service'
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /services/{serviceId}:
    get:
      tags:
        - Services
      summary: Get service
      description: Retrieve a specific service by ID (Viewer+ required)
      operationId: getService
      security:
        - BearerAuth: []
      parameters:
        - name: serviceId
          in: path
          required: true
          description: Service ID
          schema:
            type: string
      responses:
        '200':
          description: Service details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Services
      summary: Update service
      description: Update a service configuration (Developer+ required)
      operationId: updateService
      security:
        - BearerAuth: []
      parameters:
        - name: serviceId
          in: path
          required: true
          description: Service ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceUpdate'
      responses:
        '200':
          description: Service updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags:
        - Services
      summary: Partially update service
      description: Partially update a service configuration (Developer+ required)
      operationId: patchService
      security:
        - BearerAuth: []
      parameters:
        - name: serviceId
          in: path
          required: true
          description: Service ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceUpdate'
      responses:
        '200':
          description: Service updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Services
      summary: Delete service
      description: Delete a service (Admin+ required)
      operationId: deleteService
      security:
        - BearerAuth: []
      parameters:
        - name: serviceId
          in: path
          required: true
          description: Service ID
          schema:
            type: string
      responses:
        '204':
          description: Service deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /proxy/status:
    get:
      tags:
        - Proxy
      summary: Get proxy status
      description: Get the current status of the proxy service (Admin+ required)
      operationId: getProxyStatus
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Proxy status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /proxy/restart:
    post:
      tags:
        - Proxy
      summary: Restart proxy
      description: Restart the proxy service (Admin+ required)
      operationId: restartProxy
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Proxy restarted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Proxy restarted successfully"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /proxy/add:
    post:
      tags:
        - Proxy
      summary: Add proxy route
      description: Add a new route to the proxy configuration (Admin+ required)
      operationId: addProxyRoute
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProxyRoute'
      responses:
        '201':
          description: Route added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Route added successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /proxy/remove:
    delete:
      tags:
        - Proxy
      summary: Remove proxy route
      description: Remove a route from the proxy configuration (Admin+ required)
      operationId: removeProxyRoute
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Route removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Route removed successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/status:
    get:
      tags:
        - System
      summary: Get system status
      description: Get overall system health and status (Viewer+ required)
      operationId: getSystemStatus
      security:
        - BearerAuth: []
      responses:
        '200':
          description: System status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/info:
    get:
      tags:
        - System
      summary: Get system information
      description: Get system version and configuration info (Admin+ required)
      operationId: getSystemInfo
      security:
        - BearerAuth: []
      responses:
        '200':
          description: System information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/doctor:
    post:
      tags:
        - System
      summary: Run system doctor
      description: Run system diagnostics and attempt auto-fixes for core dependencies.
      operationId: runSystemDoctor
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Doctor completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemDoctorResult'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/install:
    post:
      tags:
        - System
      summary: Install or upgrade dployr
      description: Install a specific version of dployr or the latest version, then run the system doctor.
      operationId: installSystem
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstallRequest'
      responses:
        '200':
          description: Install and doctor completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemDoctorResult'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/restart:
    post:
      tags:
        - System
      summary: Restart dployrd
      description: |
        The daemon sets its mode to `updating` before initiating the reboot to prevent
        new tasks from being accepted.

        Developer role is required.
      operationId: restartSystem
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestartRequest'
      responses:
        '200':
          description: Restart initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestartResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'
  
  /system/reboot:
    post:
      tags:
        - System
      summary: Reboot the OS
      description: |
        The daemon sets its mode to `updating` before initiating the reboot to prevent
        new tasks from being accepted.

        Admin role is required.
      operationId: rebootSystem
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RebootRequest'
      responses:
        '200':
          description: Reboot initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RebootResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/register:
    post:
      tags:
        - System
      summary: Register instance with base
      description: |
        Register this dployr instance with the dployr base.

        This endpoint is typically called by base with a signed claim token and
        instance metadata. It does **not** require authentication but validates
        the claim against the locally stored token obtained from base during
        installation.
      operationId: registerInstance
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterInstanceRequest'
      responses:
          description: Instance successfully registered
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/domain:
    post:
      tags:
        - System
      summary: Request domain from base
      description: |
        Request and assign a managed domain for this dployr instance from the base control plane.

        This endpoint is typically called during installation with a token issued by base and
        the instance's address. It does **not** require authentication.
      operationId: requestDomain
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestDomainRequest'
      responses:
        '200':
          description: Domain successfully requested and instance registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestDomainResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/token/rotate:
    post:
      tags:
        - System
      summary: Update instance bootstrap token
      description: |
        Replace the locally stored bootstrap token for this instance.
      operationId: updateBootstrapToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: New bootstrap token JWT issued by base for this instance
      responses:
        '200':
          description: Bootstrap token updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/tasks:
    get:
      tags:
        - System
      summary: Get task summary
      description: |
        Return a simple count of tasks for a given status.

        - `pending`: tasks that are currently in progress on this daemon.
        - `completed`: tasks that have finished execution but have not yet
          been fully acknowledged by base.

        Viewer+ role is required.
      operationId: getSystemTasks
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: Task status to summarize ("pending" or "completed")
          required: false
          schema:
            type: string
            enum: [pending, completed]
            default: pending
      responses:
        '200':
          description: Task summary for the given status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/mode:
    get:
      tags:
        - System
      summary: Get daemon mode
      description: |
        Return the current high-level mode of the daemon.

        - `ready`: normal operation, syncer active.
        - `updating`: an installation or upgrade is in progress; syncer
          skips fetching new tasks from base.

        Viewer+ role is required.
      operationId: getDaemonMode
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current daemon mode
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - System
      summary: Set daemon mode
      description: |
        Update the high-level mode of the daemon.

        This endpoint is intended for **agent role** automation only.

        - `ready`: resume normal operation.
        - `updating`: enter an update window; the syncer will stop
          fetching new tasks from base until the mode is set back to
          `ready`.
      operationId: setDaemonMode
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetModeRequest'
      responses:
        '200':
          description: Updated daemon mode
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/agent/instances/{instanceId}/cert:
    post:
      tags:
        - Agent
      summary: Register agent client certificate
      description: |
        Register the mTLS client certificate for a specific agent instance.

        This endpoint is called by the agent daemon using an **agent access token**
        obtained from base. It is typically invoked automatically before opening
        the WebSocket control channel.
      operationId: registerAgentCert
      security:
        - BearerAuth: []
      parameters:
        - name: instanceId
          in: path
          required: true
          description: Agent instance identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCertUpdate'
      responses:
        '204':
          description: Client certificate registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Certificate already exists for this instance
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Agent
      summary: Rotate agent client certificate
      description: |
        Rotate the mTLS client certificate for a specific agent instance.

        This is typically used when the agent has generated a new keypair and
        needs to replace the previously registered certificate.
      operationId: rotateAgentCert
      security:
        - BearerAuth: []
      parameters:
        - name: instanceId
          in: path
          required: true
          description: Agent instance identifier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCertUpdate'
      responses:
        '204':
          description: Client certificate rotated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Runtime:
      type: string
      enum:
        - static
        - golang
        - php
        - python
        - nodejs
        - ruby
        - dotnet
        - java
        - docker
        - k3s
        - custom

    RuntimeObj:
      type: object
      required:
        - type
      properties:
        type:
          $ref: '#/components/schemas/Runtime'
        version:
          type: string
          example: "18.0.0"

    RemoteObj:
      type: object
      properties:
        url:
          type: string
          format: uri
          example: "https://github.com/user/repo.git"
        branch:
          type: string
          example: "main"
        commit_hash:
          type: string
          example: "abc123def456"

    Blueprint:
      type: object
      required:
        - name
        - source
        - runtime
      properties:
        name:
          type: string
          example: "my-app"
        description:
          type: string
          example: "My application description"
        source:
          type: string
          enum: [remote, image]
        runtime:
          $ref: '#/components/schemas/RuntimeObj'
        remote:
          $ref: '#/components/schemas/RemoteObj'
        run_cmd:
          type: string
          example: "npm start"
        build_cmd:
          type: string
          example: "npm run build"
        port:
          type: integer
          minimum: 1025
          maximum: 9999
          example: 3000
        working_dir:
          type: string
          example: "/app"
        static_dir:
          type: string
          example: "/app/dist"
        image:
          type: string
          example: "node:18-alpine"
        env_vars:
          type: object
          additionalProperties:
            type: string
          example:
            NODE_ENV: "production"
            PORT: "3000"
        status:
          type: string
        project_id:
          type: string

    DeploymentStatus:
      type: string
      enum:
        - pending
        - in_progress
        - failed
        - completed

    Deployment:
      type: object
      properties:
        id:
          type: string
          example: "01HN2K3M4N5P6Q7R8S9T0U1V2W"
        user_id:
          type: string
          description: ID of the user who created the deployment
        user_email:
          type: string
          format: email
          description: Email of the user who created the deployment
        config:
          $ref: '#/components/schemas/Blueprint'
        status:
          $ref: '#/components/schemas/DeploymentStatus'
        metadata:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    DeployRequest:
      type: object
      required:
        - name
        - user_id
        - source
        - runtime
      properties:
        name:
          type: string
          example: "my-app"
        description:
          type: string
          example: "My application description"
        user_id:
          type: string
        source:
          type: string
          enum: [remote, image]
        runtime:
          $ref: '#/components/schemas/RuntimeObj'
        version:
          type: string
        run_cmd:
          type: string
          example: "npm start"
        build_cmd:
          type: string
          example: "npm run build"
        port:
          type: integer
          minimum: 1
          maximum: 65535
          example: 3000
        working_dir:
          type: string
          example: "/app"
        static_dir:
          type: string
          example: "/app/dist"
        image:
          type: string
          example: "node:18-alpine"
        env_vars:
          type: object
          additionalProperties:
            type: string
        secrets:
          type: object
          additionalProperties:
            type: string
        remote:
          $ref: '#/components/schemas/RemoteObj'
        domain:
          type: string
          example: "myapp.example.com"
        dns_provider:
          type: string
          example: "cloudflare"

    DeployResponse:
      type: object
      properties:
        success:
          type: boolean
        id:
          type: string
          example: "01HN2K3M4N5P6Q7R8S9T0U1V2W"
        name:
          type: string
          example: "my-app"
        created_at:
          type: string
          format: date-time

    Service:
      type: object
      properties:
        id:
          type: string
          example: "01HN2K3M4N5P6Q7R8S9T0U1V2W"
        name:
          type: string
          example: "my-service"
        description:
          type: string
          example: "My service description"
        source:
          type: string
        runtime:
          $ref: '#/components/schemas/Runtime'
        runtime_version:
          type: string
          example: "18.0.0"
        run_cmd:
          type: string
          example: "npm start"
        build_cmd:
          type: string
          example: "npm run build"
        port:
          type: integer
          example: 3000
        working_dir:
          type: string
          example: "/app"
        static_dir:
          type: string
          example: "/app/dist"
        image:
          type: string
          example: "node:18-alpine"
        env_vars:
          type: object
          additionalProperties:
            type: string
        status:
          type: string
        remote:
          type: string
          format: uri
        branch:
          type: string
          example: "main"
        commit_hash:
          type: string
          example: "abc123def456"
        blueprint:
          $ref: '#/components/schemas/Blueprint'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ServiceUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        runtime_version:
          type: string
        run_cmd:
          type: string
        build_cmd:
          type: string
        port:
          type: integer
          minimum: 1
          maximum: 65535
        working_dir:
          type: string
        static_dir:
          type: string
        image:
          type: string
        env_vars:
          type: object
          additionalProperties:
            type: string
        branch:
          type: string

    ProxyStatus:
      type: object
      properties:
        status:
          type: string
          example: "running"

    ProxyRoute:
      type: object
      required:
        - domain
        - upstream
      properties:
        domain:
          type: string
          example: "example.com"
        upstream:
          type: string
          example: "http://localhost:3000"

    ProxyApp:
      type: object
      description: Declarative proxy configuration served by the agent.
      properties:
        domain:
          type: string
          description: Public domain handled by the proxy.
          example: "api.example.com"
        upstream:
          type: string
          description: Local upstream (service URL or socket) receiving traffic.
          example: "http://127.0.0.1:3001"
        root:
          type: string
          nullable: true
          description: Optional document root when serving static assets.
          example: "/var/lib/dployr/apps/site"
        status:
          $ref: '#/components/schemas/ProxyStatus'
        template:
          type: string
          description: Proxy template used for the app.
          enum: [static, reverse_proxy, php_fastcgi]

    SystemStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: "healthy"
        mode:
          type: string
          description: High-level daemon mode
          enum: [ready, updating]
          example: "ready"
        uptime:
          type: string
          description: System uptime duration
          example: "72h30m15s"
        deployments:
          type: array
          description: Recent deployments.
          items:
            $ref: '#/components/schemas/Deployment'
        services:
          type: array
          description: Services currently configured on the agent.
          items:
            $ref: '#/components/schemas/Service'
        proxies:
          type: array
          description: Active proxy applications exposed by the agent.
          items:
            $ref: '#/components/schemas/ProxyApp'
        proxy:
          type: object
          properties:
            status:
              type: string
              example: "running"
            routes:
              type: integer
              example: 3
        health:
          type: object
          properties:
            overall:
              type: string
              description: Overall health status
              enum: [ok, degraded, down]
            ws:
              type: string
              description: WebSocket health status
              enum: [ok, degraded, down]
            tasks:
              type: string
              description: Task execution health status
              enum: [ok, degraded, down]
            auth:
              type: string
              description: Auth/token health status
              enum: [ok, degraded, down]
        debug:
          type: object
          nullable: true
          properties:
            ws:
              type: object
              properties:
                connected:
                  type: boolean
                last_connect_at:
                  type: string
                  format: date-time
                reconnects_since_start:
                  type: integer
                last_error:
                  type: string
                  nullable: true
            tasks:
              type: object
              properties:
                inflight:
                  type: integer
                done_unsent:
                  type: integer
                last_task_id:
                  type: string
                  nullable: true
                last_task_status:
                  type: string
                  nullable: true
                last_task_dur_ms:
                  type: integer
                  nullable: true
                last_task_at:
                  type: string
                  format: date-time
                  nullable: true
            auth:
              type: object
              nullable: true
              properties:
                agent_token_age_s:
                  type: integer
                agent_token_expires_in_s:
                  type: integer
            system:
              type: object
              nullable: true
              properties:
                cpu_count:
                  type: integer
                mem_total_bytes:
                  type: integer
                  format: int64
                  nullable: true
                mem_used_bytes:
                  type: integer
                  format: int64
                  nullable: true
                mem_free_bytes:
                  type: integer
                  format: int64
                  nullable: true
                disks:
                  type: array
                  items:
                    type: object
                    properties:
                      filesystem:
                        type: string
                      mountpoint:
                        type: string
                      size_bytes:
                        type: integer
                        format: int64
                        nullable: true
                      used_bytes:
                        type: integer
                        format: int64
                        nullable: true
                      available_bytes:
                        type: integer
                        format: int64
                        nullable: true

    SystemInfo:
      type: object
      properties:
        build:
          type: object
          properties:
            version:
              type: string
              example: "v0.1.1-beta.17"
            commit:
              type: string
              example: "a1b2c3d4"
            build_date:
              type: string
              description: Build date - bundled at build time
            go_version:
              type: string
              example: "go1.21.0"
        hardware:
          type: object
          properties:
            os:
              type: string
              example: "linux"
            arch:
              type: string
              example: "amd64"
            cpu_count:
              type: integer
              example: 8
            hostname:
              type: string
              nullable: true
            kernel:
              type: string
              nullable: true
              example: "Linux 6.8.0-35-generic"
            mem_total:
              type: string
              nullable: true
              example: "7.5Gi"
            mem_used:
              type: string
              nullable: true
            mem_free:
              type: string
              nullable: true
            swap_total:
              type: string
              nullable: true
            swap_used:
              type: string
              nullable: true
        storage:
          type: object
          properties:
            partitions:
              type: array
              items:
                type: object
                properties:
                  filesystem:
                    type: string
                  size:
                    type: string
                  used:
                    type: string
                  available:
                    type: string
                  use_percent:
                    type: string
                  mountpoint:
                    type: string
            devices:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  size:
                    type: string
                  type:
                    type: string
                  mountpoints:
                    type: array
                    items:
                      type: string

    BuildInfo:
      type: object
      description: Build metadata for the running daemon.
      properties:
        version:
          type: string
          example: "0.4.3"
        commit:
          type: string
          example: "ad34cc94"
        date:
          type: string
          description: Build date bundled at build time
          example: "2025-11-26T21:50:07Z"
        go_version:
          type: string
          example: "go1.23.0"

    LogEntry:
      type: object
      description: |
        Structured log entry as emitted by the daemon logger.

        This mirrors the JSON output produced by the daemon's slog-based logger
        and is used in log_chunk WebSocket messages and log streaming.

        In addition to the core fields (`time`, `level`, `msg`), log entries may
        include a number of **optional structured attributes**. These are
        flattened into the top-level JSON object and exposed via
        `additionalProperties` in this schema.

        Common optional attributes include (non-exhaustive):

        - `request_id`: Correlates a log line with a specific HTTP/API request.
        - `trace_id`: End-to-end trace identifier used across components.
        - `user_id`: Authenticated user identifier (when available).
        - `instance_id`: Daemon/agent instance identifier.
        - `deployment_id`: Identifier of the related deployment.
        - `log_type`: High-level category for the log (for example, `deployment`).
        - `component`: Subsystem emitting the log (for example, `installer`,
          `syncer`, `proxy`, `deploy`, `system`).
        - `script`: Name of the script associated with the log entry (for
          example, `install`, `system_doctor`).
        - `version`: Version string associated with the operation.
        - `method`: HTTP method for API request logs.
        - `path`: HTTP request path for API request logs, or logical log path
          for some internal operations.
        - `status`: High-level status code or text for the operation (for
          example, websocket close status or HTTP-like status).
        - `service_id`: Identifier of a related service.
        - `domain`: Domain associated with proxy or routing operations.
        - `upstream`: Upstream URL/target for proxy routes.
        - `stream_id`: Identifier for a log streaming session.
        - `mode`: Log streaming mode (for example, `tail`, `historical`).
        - `resolved_path`: Fully resolved on-disk log file path.
        - `backoff_ms`: Backoff duration in milliseconds for retry logic.
        - `pinned_roots`: Boolean flag indicating whether TLS roots are pinned.
        - `host`: Base URL or host associated with a connection.
        - `count`: Number of items involved in the operation (for example,
          tasks received or acknowledgments sent).
        - `param`: Name of a request parameter involved in an error.
        - `error`: Human-readable error description or structured error object.

        Clients should treat unknown attributes as opaque metadata and must not
        rely on the full set being stable over time. New attributes may be
        added without a schema change.
      properties:
        time:
          type: string
          format: date-time
          description: RFC3339 timestamp of the log entry.
          example: "2025-11-28T16:52:03.436565635Z"
        level:
          type: string
          description: Log level.
          enum: [DEBUG, INFO, WARN, ERROR]
          example: "INFO"
        msg:
          type: string
          description: Primary log message.
          example: "syncer: received message"
      additionalProperties:
        description: Additional structured attributes attached to the log entry.
        example: "01KB5NWMWTFFA8CQDW63NCGWG5"
        oneOf:
          - type: string
          - type: number
          - type: boolean

    LogChunk:
      type: object
      description: |
        Batch of structured log entries sent as a log_chunk message over the
        agent WebSocket connection or used by higher-level log streaming APIs.
      properties:
        streamId:
          type: string
          description: Opaque stream identifier provided by the caller.
          example: "01KB5NWMWTFFA8CQDW63NCGWG5"
        path:
          type: string
          description: Relative log path under the daemon log root (for example, `app`, `install`, or `deployments/my-service`). The daemon will resolve this under `/var/log/dployrd` (or the platform-specific equivalent).
          example: "app"
        entries:
          type: array
          description: Ordered list of structured log entries in this chunk.
          items:
            $ref: '#/components/schemas/LogEntry'
        eof:
          type: boolean
          description: |
            Indicates that the stream has reached the end of file for the
            current log source. In tailing mode, new entries may still arrive
            later. In historical mode, eof=true implies no more data.
          example: false
        hasMore:
          type: boolean
          description: |
            When true, there are more historical log entries available after
            this chunk. Clients can use the offset field to request the next
            page of history.
          example: true
        offset:
          type: integer
          format: int64
          description: |
            Byte offset in the underlying log file immediately after the last
            entry in this chunk. Can be used as a cursor for subsequent
            historical log requests.
          example: 52480

    PlatformInfo:
      type: object
      description: Runtime platform information for the daemon.
      properties:
        os:
          type: string
          example: "linux"
        arch:
          type: string
          example: "amd64"
        go:
          type: string
          example: "go1.23.0"

    AgentHello:
      type: object
      description: Initial hello message sent by the agent over WebSocket.
      properties:
        schema:
          type: string
          example: "agent.hello.v1"
        instance_id:
          type: string
          example: "inst_01HXYZABCDEF123456"
        build_info:
          $ref: '#/components/schemas/BuildInfo'
        platform:
          $ref: '#/components/schemas/PlatformInfo'
        capabilities:
          type: array
          items:
            type: string
          example: ["tasks.v1", "updates.v1"]
        schemas_supported:
          type: array
          items:
            type: string
          example: ["agent.update.v1"]

    AgentUpdate:
      description: Periodic status update sent by the daemon over WebSocket.
      allOf:
        - type: object
          properties:
            schema:
              type: string
              example: "v1"
            seq:
              type: integer
              format: int64
              description: Monotonic sequence number for this connection.
            epoch:
              type: string
              description: Logical epoch identifier for this instance.
              example: "inst_01HXYZABCDEF123456-1732699234"
            full:
              type: boolean
              description: Whether this is a full status update.
            instance_id:
              type: string
            build_info:
              $ref: '#/components/schemas/BuildInfo'
            platform:
              $ref: '#/components/schemas/PlatformInfo'
        - $ref: '#/components/schemas/SystemStatus'

    SystemDoctorResult:
      type: object
      properties:
        status:
          type: string
          example: "ok"
        output:
          type: string
          description: Combined textual output from the doctor/install scripts
        error:
          type: string
          description: Error message if status is "error"

    RegisterInstanceRequest:
      type: object
      required:
        - claim
        - instance_id
      properties:
        claim:
          type: string
          description: Signed claim token issued by base
          example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        instance_id:
          type: string
          description: Unique identifier assigned to this instance by base
          example: "inst_01HXYZABCDEF123456"
        issuer:
          type: string
          description: Expected token issuer (for validation)
          example: "https://base.dployr.dev"
        audience:
          type: string
          description: Expected token audience (for validation)
          example: "dployr-instance"

    RequestDomainRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: Installation token issued by base for this instance

    InstallRequest:
      type: object
      properties:
        version:
          type: string
          description: dployr version tag to install (e.g. v0.1.1-beta.17). If omitted, installs latest.

    RestartRequest:
      type: object
      properties:
        force:
          type: boolean
          description: If true, bypass the pending tasks check and force restart
          default: false

    RestartResponse:
      type: object
      properties:
        status:
          type: string
          enum: [accepted, rejected]
          description: Whether the restart was accepted or rejected
        message:
          type: string
          description: Human-readable message about the restart status

    RebootRequest:
      type: object
      properties:
        force:
          type: boolean
          description: If true, bypass the pending tasks check and force reboot
          default: false

    RebootResponse:
      type: object
      properties:
        status:
          type: string
          enum: [accepted, rejected]
          description: Whether the reboot was accepted or rejected
        message:
          type: string
          description: Human-readable message about the reboot status

    RequestDomainResponse:
      type: object
      properties:
        domain:
          type: string
          description: Assigned domain for this instance
          example: "my-awesome-app.dployr.dev"

    FSNode:
      type: object
      description: Filesystem node with permissions
      properties:
        path:
          type: string
          description: Full path to the file or directory
        name:
          type: string
          description: Name of the file or directory
        type:
          type: string
          enum: [file, dir, symlink]
          description: Type of filesystem entry
        size_bytes:
          type: integer
          format: int64
          description: Size in bytes
        mod_time:
          type: string
          format: date-time
          description: Last modification time
        mode:
          type: string
          description: Unix permission mode string (e.g. drwxr-xr-x)
        owner:
          type: string
          description: Owner username
        group:
          type: string
          description: Group name
        uid:
          type: integer
          description: Owner user ID
        gid:
          type: integer
          description: Owner group ID
        readable:
          type: boolean
          description: Whether the agent can read this file
        writable:
          type: boolean
          description: Whether the agent can write to this file
        executable:
          type: boolean
          description: Whether this file is executable
        children:
          type: array
          items:
            $ref: '#/components/schemas/FSNode'
          description: Child nodes (for directories)
        truncated:
          type: boolean
          description: Whether the children list was truncated
        child_count:
          type: integer
          description: Total number of children if truncated

    FSListResponse:
      type: object
      properties:
        node:
          $ref: '#/components/schemas/FSNode'
        next_cursor:
          type: string
          description: Cursor for pagination
        has_more:
          type: boolean
          description: Whether more children are available

    FSReadResponse:
      type: object
      properties:
        path:
          type: string
        content:
          type: string
          description: File content (base64 for binary, utf8 for text)
        encoding:
          type: string
          enum: [base64, utf8]
        size:
          type: integer
          format: int64
          description: Total file size
        truncated:
          type: boolean
          description: Whether content was truncated

    FSWriteRequest:
      type: object
      required: [path, content]
      properties:
        path:
          type: string
          description: File path to write
        content:
          type: string
          description: Content to write (base64 or utf8)
        encoding:
          type: string
          enum: [base64, utf8]
          default: utf8
        mode:
          type: string
          description: File mode in octal (e.g. "0644")

    FSCreateRequest:
      type: object
      required: [path, type]
      properties:
        path:
          type: string
          description: Path to create
        type:
          type: string
          enum: [file, dir]
          description: Type to create
        content:
          type: string
          description: Initial content for files
        mode:
          type: string
          description: File mode in octal

    FSDeleteRequest:
      type: object
      required: [path]
      properties:
        path:
          type: string
          description: Path to delete
        recursive:
          type: boolean
          default: false
          description: Delete directories recursively

    FSOpResponse:
      type: object
      properties:
        success:
          type: boolean
        path:
          type: string
        error:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          type: object
          description: Additional error details

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: "Validation failed"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: "name"
              message:
                type: string
                example: "Field is required"

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            code: "auth.unauthorized"

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Insufficient permissions"
            code: "auth.forbidden"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Resource not found"
            code: "resource.not_found"

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            code: "runtime.internal_server_error"

    MethodNotAllowed:
      description: Method not allowed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Method not allowed"
            code: "request.method_not_allowed"

tags:
  - name: Authentication
    description: JWT authentication and token management
  - name: Users
    description: User management and role assignment
  - name: Deployments
    description: Deployment management operations
  - name: Services
    description: Service management operations
  - name: Logs
    description: Log streaming operations
  - name: Proxy
    description: Proxy configuration and management
  - name: System
    description: System status and information
  - name: Filesystem
    description: Filesystem browsing and file operations